<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Iron Log</title>
    
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 50; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans min-h-screen pb-20">

    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <i class="fas fa-dumbbell fa-spin text-4xl text-green-500 mb-4"></i>
            <p class="text-slate-400 text-sm animate-pulse">กำลังโหลดข้อมูล Iron Log...</p>
        </div>
    </div>

    <div class="fixed top-0 left-0 right-0 bg-slate-900/90 backdrop-blur-md z-40 border-b border-slate-800 px-4 py-3 flex items-center justify-between">
        <button onclick="goBack()" class="text-slate-400 hover:text-white p-2">
            <i class="fas fa-chevron-left text-xl"></i>
        </button>
        <h1 class="text-lg font-bold text-green-500 tracking-wider">IRON LOG</h1>
        <div class="w-8"></div> </div>

    <div class="max-w-md mx-auto pt-20 px-4">

        <div class="flex bg-slate-800 p-1 rounded-xl mb-6">
            <button onclick="switchTab('weight')" id="tabWeight" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all bg-slate-700 text-white shadow">
                <i class="fas fa-weight mr-1"></i> น้ำหนัก
            </button>
            <button onclick="switchTab('photo')" id="tabPhoto" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all text-slate-400 hover:text-slate-200">
                <i class="fas fa-camera mr-1"></i> รูปภาพ
            </button>
        </div>

        <div id="sectionWeight">
            <div class="bg-slate-800 p-4 rounded-2xl shadow-lg border border-slate-700 mb-6">
                <div class="flex gap-3 mb-4">
                    <div class="flex-1">
                        <label class="text-xs text-slate-400 uppercase">วันที่</label>
                        <input type="date" id="weightDate" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-white outline-none focus:border-green-500 transition">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-slate-400 uppercase">น้ำหนัก (Kg)</label>
                        <input type="number" id="weightVal" step="0.01" placeholder="0.00" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-white outline-none focus:border-green-500 transition text-center font-bold text-lg">
                    </div>
                </div>
                <button onclick="saveWeight()" id="btnSaveWeight" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-green-900/30 transition active:scale-95">
                    บันทึกข้อมูล
                </button>
            </div>

            <div class="bg-slate-800 p-4 rounded-2xl shadow-lg border border-slate-700 mb-6 relative">
                <h3 class="text-xs text-slate-400 uppercase mb-2 font-bold">แนวโน้มน้ำหนัก (7 ครั้งล่าสุด)</h3>
                <canvas id="weightChart" height="200"></canvas>
            </div>

            <h3 class="text-sm font-bold text-slate-300 mb-3 px-1">ประวัติการชั่งน้ำหนัก</h3>
            <div id="weightList" class="space-y-3 pb-10">
                </div>
        </div>

        <div id="sectionPhoto" class="hidden">
            <div class="bg-slate-800 p-4 rounded-2xl shadow-lg border border-slate-700 mb-6">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-xs text-slate-400 block mb-1">วันที่</label>
                        <input type="date" id="photoDate" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-white text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 block mb-1">น้ำหนักขณะถ่าย</label>
                        <input type="number" id="photoWeight" step="0.01" placeholder="kg" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-white text-sm font-bold">
                    </div>
                </div>
                
                <input type="file" id="photoInput" accept="image/*" class="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-slate-700 file:text-green-500 hover:file:bg-slate-600 mb-4">
                
                <button onclick="uploadPhoto()" id="btnUploadPhoto" class="w-full bg-slate-700 hover:bg-slate-600 text-green-400 font-bold py-3 rounded-xl border border-green-500/30 transition">
                    <i class="fas fa-cloud-upload-alt mr-2"></i> อัปโหลดรูปภาพ
                </button>
            </div>

            <div id="galleryGrid" class="grid grid-cols-1 gap-6 pb-10">
                </div>
        </div>

    </div>

    <script>
        const API_URL = CONFIG.SCRIPT_URL;
        let chartInstance = null;
        let globalData = { weights: [], gallery: [] };

        // --- INIT ---
        window.onload = () => {
            // Set Default Dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('weightDate').value = today;
            document.getElementById('photoDate').value = today;
            
            loadData();
        };

        function goBack() {
            // แก้ไขลิงก์นี้ให้ตรงกับหน้าหลักของคุณ เช่น index.html
            window.location.href = 'index.html'; 
        }

        function switchTab(tab) {
            const wSec = document.getElementById('sectionWeight');
            const pSec = document.getElementById('sectionPhoto');
            const wTab = document.getElementById('tabWeight');
            const pTab = document.getElementById('tabPhoto');

            if (tab === 'weight') {
                wSec.classList.remove('hidden');
                pSec.classList.add('hidden');
                wTab.classList.replace('text-slate-400', 'text-white');
                wTab.classList.replace('bg-transparent', 'bg-slate-700');
                wTab.classList.add('shadow');
                pTab.classList.replace('text-white', 'text-slate-400');
                pTab.classList.replace('bg-slate-700', 'bg-transparent');
                pTab.classList.remove('shadow');
                renderChart(); // Re-render chart to fit container
            } else {
                wSec.classList.add('hidden');
                pSec.classList.remove('hidden');
                pTab.classList.replace('text-slate-400', 'text-white');
                pTab.classList.replace('bg-transparent', 'bg-slate-700');
                pTab.classList.add('shadow');
                wTab.classList.replace('text-white', 'text-slate-400');
                wTab.classList.replace('bg-slate-700', 'bg-transparent');
                wTab.classList.remove('shadow');
            }
        }

        // --- DATA LOADING ---
        async function loadData() {
            try {
                const res = await fetch(`${API_URL}?get=fitnessData&t=${new Date().getTime()}`);
                const data = await res.json();
                
                globalData.weights = data.weights || [];
                globalData.gallery = data.gallery || [];

                renderWeightList();
                renderChart();
                renderGallery();

                // Hide Loading
                document.getElementById('loadingOverlay').style.opacity = '0';
                setTimeout(() => document.getElementById('loadingOverlay').remove(), 500);

            } catch (e) {
                console.error(e);
                Swal.fire('Error', 'ไม่สามารถโหลดข้อมูลได้', 'error');
            }
        }

        // --- WEIGHT FUNCTIONS ---
        async function saveWeight() {
            const date = document.getElementById('weightDate').value;
            const weight = document.getElementById('weightVal').value;
            const btn = document.getElementById('btnSaveWeight');

            if (!date || !weight) return Swal.fire('ข้อมูลไม่ครบ', 'กรุณาระบุวันที่และน้ำหนัก', 'warning');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> บันทึก...';

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'saveWeight', date: date, weight: weight })
                });
                const result = await res.json();
                if (result.status === 'success') {
                    // Update Local Data (Optimistic UI)
                    // Reload is safer to ensure sorting logic from backend
                    await loadData(); 
                    Swal.fire({
                        icon: 'success',
                        title: 'บันทึกสำเร็จ',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 1500
                    });
                } else throw new Error(result.message);
            } catch (e) {
                Swal.fire('Error', e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'บันทึกข้อมูล';
            }
        }

        async function deleteWeight(dateStr) {
            const confirm = await Swal.fire({
                title: 'ยืนยันการลบ',
                text: `ต้องการลบข้อมูลวันที่ ${formatDate(dateStr)} หรือไม่?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'ลบเลย',
                cancelButtonText: 'ยกเลิก'
            });

            if (confirm.isConfirmed) {
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'deleteWeight', date: dateStr })
                    });
                    loadData();
                } catch (e) { Swal.fire('Error', e.message, 'error'); }
            }
        }

        function renderWeightList() {
            const list = document.getElementById('weightList');
            list.innerHTML = '';
            
            const weights = globalData.weights; // Sorted desc by date

            if (weights.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-500 py-6">ยังไม่มีข้อมูลน้ำหนัก</div>';
                return;
            }

            weights.forEach((item, index) => {
                // คำนวณความต่าง
                let diffHtml = '';
                if (index < weights.length - 1) {
                    const current = parseFloat(item.value);
                    const prev = parseFloat(weights[index + 1].value); // ตัวถัดไปคือวันก่อนหน้า
                    const diff = current - prev;
                    
                    if (diff > 0) {
                        diffHtml = `<span class="text-red-400 text-xs font-bold"><i class="fas fa-arrow-up"></i> +${diff.toFixed(2)}</span>`;
                    } else if (diff < 0) {
                        diffHtml = `<span class="text-green-400 text-xs font-bold"><i class="fas fa-arrow-down"></i> ${diff.toFixed(2)}</span>`;
                    } else {
                        diffHtml = `<span class="text-slate-500 text-xs font-bold">-</span>`;
                    }
                } else {
                    diffHtml = `<span class="text-slate-500 text-xs text-xs bg-slate-700 px-1 rounded">START</span>`;
                }

                const d = formatDate(item.date);
                
                list.innerHTML += `
                    <div class="bg-slate-800 p-4 rounded-xl border border-white/5 flex justify-between items-center hover:bg-slate-750 transition relative group">
                        <div class="flex items-center gap-4">
                            <div class="bg-slate-700 w-12 h-12 rounded-full flex items-center justify-center text-slate-300 font-bold text-sm shadow-inner">
                                ${parseFloat(item.value).toFixed(1)}
                            </div>
                            <div>
                                <div class="text-sm font-bold text-slate-200">${d}</div>
                                <div class="mt-1">${diffHtml}</div>
                            </div>
                        </div>
                        <button onclick="deleteWeight('${item.date}')" class="text-slate-600 hover:text-red-400 p-2 transition">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
            });
            
            // Auto fill weight in Photo tab if today exists
            const todayStr = document.getElementById('photoDate').value;
            const todayWeight = weights.find(w => new Date(w.date).toISOString().split('T')[0] === todayStr);
            if (todayWeight) {
                document.getElementById('photoWeight').value = todayWeight.value;
            }
        }

        function renderChart() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            
            // Prepare Data (Reverse for chart: Old -> New)
            // เอาแค่ 7 วันล่าสุด
            const chartData = [...globalData.weights].slice(0, 7).reverse();
            
            const labels = chartData.map(d => {
                const dt = new Date(d.date);
                return `${dt.getDate()}/${dt.getMonth()+1}`;
            });
            const dataPoints = chartData.map(d => d.value);

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight (kg)',
                        data: dataPoints,
                        borderColor: '#22c55e', // Green-500
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#22c55e',
                        pointRadius: 4,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#94a3b8' } 
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        // --- PHOTO FUNCTIONS ---
        function renderGallery() {
            const list = document.getElementById('galleryGrid');
            list.innerHTML = '';
            
            if (globalData.gallery.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-500 italic">ยังไม่มีรูปภาพ</div>';
                return;
            }

            globalData.gallery.forEach(img => {
                const d = formatDate(img.date);
                const weightTag = img.weight ? `<span class="bg-black/50 text-white text-xs px-2 py-1 rounded backdrop-blur-sm"><i class="fas fa-weight-hanging mr-1"></i>${img.weight} kg</span>` : '';

                list.innerHTML += `
                    <div class="bg-slate-800 rounded-2xl overflow-hidden shadow-2xl border border-white/5 relative group">
                        <div class="relative">
                            <img src="${img.url}" class="w-full h-auto object-cover min-h-[250px] bg-slate-700" loading="lazy" referrerpolicy="no-referrer">
                            
                            <div class="absolute bottom-2 right-2 flex gap-1">
                                ${weightTag}
                            </div>
                        </div>
                        
                        <div class="p-3 bg-slate-800 flex justify-between items-center">
                            <span class="text-sm font-bold text-slate-300">${d}</span>
                            <button class="text-slate-600 hover:text-red-500 text-sm"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
            });
        }

        async function uploadPhoto() {
            const fileInput = document.getElementById('photoInput');
            const date = document.getElementById('photoDate').value;
            const weight = document.getElementById('photoWeight').value;
            const btn = document.getElementById('btnUploadPhoto');

            if (fileInput.files.length === 0) return Swal.fire('แจ้งเตือน', 'เลือกรูปก่อนครับ', 'warning');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังอัปโหลด...';

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'uploadPhoto',
                            date: date,
                            weight: weight, // ส่งน้ำหนักไปด้วย
                            image: e.target.result
                        })
                    });
                    const result = await res.json();
                    if (result.status === 'success') {
                        Swal.fire('สำเร็จ', 'อัปโหลดเรียบร้อย', 'success');
                        fileInput.value = '';
                        loadData(); // Reload all
                    } else throw new Error(result.message);
                } catch (err) { Swal.fire('Error', err.message, 'error'); } 
                finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-cloud-upload-alt mr-2"></i> อัปโหลดรูปภาพ'; }
            };
            reader.readAsDataURL(file);
        }

        // Utils
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
        }
    </script>
</body>
</html>
